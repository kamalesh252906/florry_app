<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password - Florry</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles/auth-style.css">
    <style>
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="auth-container">
        <div class="auth-left">
            <div class="back-link">
                <a href="./landing.html" id="back-to-login">‚Üê Back to Login</a>
            </div>
            <div class="auth-brand">
                <h1>Florry</h1>
                <p>Recovery Portal</p>
            </div>
        </div>

        <div class="auth-right">
            <div class="auth-form-box">
                <h2>Reset Password</h2>
                <p class="subtitle" id="form-subtitle">Enter your email and new password to recover access</p>

                <div id="reset-form-container">
                    <form onsubmit="handleForgotPassword(event)">
                        <div class="input-group">
                            <label>User Type</label>
                            <select id="user-type" style="width: 100%; padding: 15px; border: 2.5px solid #f1f3f5; border-radius: 12px; margin-bottom: 20px;">
                                <option value="customer">Customer</option>
                                <option value="admin">Store Admin</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label>Email Address <span class="required">*</span></label>
                            <input type="email" id="reset-email" placeholder="Enter your registered email" required>
                        </div>

                        <div class="input-group">
                            <label>New Password <span class="required">*</span></label>
                            <input type="password" id="new-password" placeholder="Enter new password" required minlength="6">
                        </div>

                        <button type="submit" class="submit-btn" id="reset-btn" style="background: var(--primary); color: white;">Save New Password</button>
                    </form>
                </div>

                <div id="success-message" class="hidden" style="text-align: center;">
                    <h3 style="margin-top: 20px;">Password Updated!</h3>
                    <p style="color: #666; margin-bottom: 30px;">Your password has been reset successfully.</p>
                    <button class="submit-btn" onclick="redirectToLogin()" style="background: var(--primary); color: white;">Return to Login</button>
                </div>

                <div class="switch-auth">
                    <p>Remembered your password? <a href="./customer_login.html" id="login-link">Login here</a></p>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/config.js"></script>
    <script src="../js/api.js"></script>
    <script>
        // Adjust back links based on where they came from
        const urlParams = new URLSearchParams(window.location.search);
        const type = urlParams.get('type');
        
        if (type === 'admin') {
            document.getElementById('user-type').value = 'admin';
            document.getElementById('back-to-login').href = './admin_login.html';
            document.getElementById('login-link').href = './admin_login.html';
        }

        async function handleForgotPassword(event) {
            event.preventDefault();
            
            const email = document.getElementById('reset-email').value;
            const newPassword = document.getElementById('new-password').value;
            const userType = document.getElementById('user-type').value;
            const btn = document.getElementById('reset-btn');
            
            btn.disabled = true;
            btn.textContent = 'Processing...';

            try {
                if (userType === 'customer') {
                    await api.userForgotPassword(email);
                    await api.userResetPassword(email, newPassword);
                } else {
                    await api.adminForgotPassword(email);
                    await api.adminResetPassword(email, newPassword);
                }

                document.getElementById('reset-form-container').classList.add('hidden');
                document.getElementById('success-message').classList.remove('hidden');
                document.getElementById('form-subtitle').style.display = 'none';
                
            } catch (error) {
                alert('Error: ' + error.message);
                btn.disabled = false;
                btn.textContent = 'Save New Password';
            }
        }

        function redirectToLogin() {
            const userType = document.getElementById('user-type').value;
            if (userType === 'admin') {
                window.location.href = './admin_login.html';
            } else {
                window.location.href = './customer_login.html';
            }
        }
    </script>
</body>
</html>
